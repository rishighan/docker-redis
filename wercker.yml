box: pivotaldata/ubuntu:16
build:
  steps:
    - script:
        name: empty build step
        code: |
          echo "Empty build step"
deploy:
  steps:
    - script:
      name: "install openssh"
      code: |
        sudo apt-get update
        sudo apt-get -qq -y install openssh-server openssh-client
    - script:
      name: "move redis config into place"
      code: |
        ls al /
    - internal/docker-push:
      username: $DOCKER_USERNAME
      password: $DOCKER_PASSWORD
      repository: $DOCKER_USERNAME/$DOCKER_IMAGE
      ports: "6379"
      cmd: "/bin/bash -c \" $(which redis-server) /etc/redis/redis.conf\""

    - add-ssh-key:
        keyname: DIGITALOCEAN
    - add-to-known_hosts:
        hostname: $DIGITALOCEAN_HOST
    - script:
        name: pull latest image
        code: ssh root@$DIGITALOCEAN_HOST docker pull $DOCKER_USERNAME/$DOCKER_IMAGE:latest
    - script:
        name: stop running container
        code: ssh root@$DIGITALOCEAN_HOST docker stop rgredis || echo "failed to stop running container"
    - script:
        name: remove stopped container
        code: ssh root@$DIGITALOCEAN_HOST docker rm rgredis || echo "failed to remove stopped container"
    - script:
        name: remove image behind stopped container
        code: ssh root@$DIGITALOCEAN_HOST docker rmi -f $DOCKER_USERNAME/$DOCKER_IMAGE:latest || echo "failed to remove image behind stopped container"
    - script:
        name: run new container
        code: ssh root@$DIGITALOCEAN_HOST docker run -p 6379:6379 --name rgredis $DOCKER_USERNAME/$DOCKER_IMAGE:latest

